# 4.æ–‡æ¡£æ“ä½œ

æ–‡æ¡£æ“ä½œç›¸å½“äºæ˜¯æ•°æ®çš„æ“ä½œ

> [å‚è€ƒåšå®¢](https://www.cnblogs.com/xiaoyuanqujing/articles/11805775.html)

## ç›®å½•

- [4.æ–‡æ¡£æ“ä½œ](#4æ–‡æ¡£æ“ä½œ)
  - [ç›®å½•](#ç›®å½•)
  - [å¢åŠ ](#å¢åŠ )
  - [æŸ¥](#æŸ¥)
    - [æ¯”è¾ƒè¿ç®—](#æ¯”è¾ƒè¿ç®—)
    - [é€»è¾‘è¿ç®—](#é€»è¾‘è¿ç®—)
    - [æˆå‘˜è¿ç®—](#æˆå‘˜è¿ç®—)
    - [æ­£åˆ™åŒ¹é…](#æ­£åˆ™åŒ¹é…)
    - [å–æŒ‡å®šçš„å­—æ®µ](#å–æŒ‡å®šçš„å­—æ®µ)
    - [æŸ¥è¯¢æ•°ç»„](#æŸ¥è¯¢æ•°ç»„)
    - [æ’åº](#æ’åº)
    - [åˆ†é¡µ](#åˆ†é¡µ)
    - [è·å–æ•°é‡](#è·å–æ•°é‡)
    - [æ‚é¡¹](#æ‚é¡¹)
  - [æ”¹](#æ”¹)
    - [updateè¯­æ³•ä»‹ç»](#updateè¯­æ³•ä»‹ç»)
    - [è¦†ç›–å¼](#è¦†ç›–å¼)
    - [è®¾ç½®set](#è®¾ç½®set)
    - [å¢åŠ å’Œå‡å°‘ï¼š$inc](#å¢åŠ å’Œå‡å°‘inc)
    - [æ·»åŠ åˆ é™¤æ•°ç»„å†…å…ƒç´ ï¼šğ‘ğ‘¢ğ‘ â„,pop,$pull](#æ·»åŠ åˆ é™¤æ•°ç»„å†…å…ƒç´ ğ‘ğ‘¢ğ‘ â„poppull)
    - [é¿å…æ·»åŠ é‡å¤ï¼š"$addToSet"](#é¿å…æ·»åŠ é‡å¤addtoset)
    - [å¦‚æœè¦ä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ª(ä¾‹å¦‚åˆ—è¡¨ä¸€ç±»)](#å¦‚æœè¦ä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ªä¾‹å¦‚åˆ—è¡¨ä¸€ç±»)
    - [å…¶ä»–](#å…¶ä»–)
  - [åˆ é™¤](#åˆ é™¤)
  - [èšåˆ](#èšåˆ)
      - [å‡†å¤‡æ•°æ®](#å‡†å¤‡æ•°æ®)
      - [ç­›é€‰ï¼š$match](#ç­›é€‰match)
      - [æŠ•å°„ï¼š$project](#æŠ•å°„project)
      - [åˆ†ç»„ï¼š$group](#åˆ†ç»„group)
      - [æ’åºï¼šğ‘ ğ‘œğ‘Ÿğ‘¡ã€é™åˆ¶ï¼šlimitã€è·³è¿‡ï¼š$skip](#æ’åºğ‘ ğ‘œğ‘Ÿğ‘¡é™åˆ¶limitè·³è¿‡skip)
      - [éšæœºé€‰å–nä¸ªï¼š$sample](#éšæœºé€‰å–nä¸ªsample)
  - [ç»ƒä¹ é¢˜](#ç»ƒä¹ é¢˜)
    - [ç»ƒä¹ ç­”æ¡ˆ](#ç»ƒä¹ ç­”æ¡ˆ)
  - [å¯è§†åŒ–å·¥å…·](#å¯è§†åŒ–å·¥å…·)
  - [pymongo](#pymongo)

## å¢åŠ 

```sql
#1ã€æ²¡æœ‰æŒ‡å®š_idåˆ™é»˜è®¤ObjectId,_idä¸èƒ½é‡å¤ï¼Œä¸”åœ¨æ’å…¥åä¸å¯å˜

#2ã€æ’å…¥å•æ¡
user0={
    "name":"egon",
    "age":10,
    'hobbies':['music','read','dancing'],
    'addr':{
        'country':'China',
        'city':'BJ'
    }
}

db.test.insert(user0)
db.test.find()

#3ã€æ’å…¥å¤šæ¡
user1={
    "_id":1,
    "name":"alex",
    "age":10,
    'hobbies':['music','read','dancing'],
    'addr':{
        'country':'China',
        'city':'weifang'
    }
}

user2={
    "_id":2,
    "name":"wupeiqi",
    "age":20,
    'hobbies':['music','read','run'],
    'addr':{
        'country':'China',
        'city':'hebei'
    }
}

user3={
    "_id":3,
    "name":"yuanhao",
    "age":30,
    'hobbies':['music','drink'],
    'addr':{
        'country':'China',
        'city':'heibei'
    }
}

user4={
    "_id":4,
    "name":"jingliyang",
    "age":40,
    'hobbies':['music','read','dancing','tea'],
    'addr':{
        'country':'China',
        'city':'BJ'
    }
}

user5={
    "_id":5,
    "name":"jinxin",
    "age":50,
    'hobbies':['music','read',],
    'addr':{
        'country':'China',
        'city':'henan'
    }
}
db.user.insertMany([user1,user2,user3,user4,user5])
```

## æŸ¥

### æ¯”è¾ƒè¿ç®—

```sql
# SQLï¼š=,!=,>,<,>=,<=
# MongoDBï¼š{key:value}ä»£è¡¨ä»€ä¹ˆç­‰äºä»€ä¹ˆ,"$ne","$gt","$lt","gte","lte",å…¶ä¸­"$ne"èƒ½ç”¨äºæ‰€æœ‰æ•°æ®ç±»å‹

#1ã€select * from db1.user where name = "alex";
db.user.find({'name':'alex'})

#2ã€select * from db1.user where name != "alex";
db.user.find({'name':{"$ne":'alex'}})

#3ã€select * from db1.user where id > 2;
db.user.find({'_id':{'$gt':2}})

#4ã€select * from db1.user where id < 3;
db.user.find({'_id':{'$lt':3}})

#5ã€select * from db1.user where id >= 2;
db.user.find({"_id":{"$gte":2,}})

#6ã€select * from db1.user where id <= 2;
db.user.find({"_id":{"$lte":2}})
```

### é€»è¾‘è¿ç®—

```sql
# SQLï¼šandï¼Œorï¼Œnot
# MongoDBï¼šå­—å…¸ä¸­é€—å·åˆ†éš”çš„å¤šä¸ªæ¡ä»¶æ˜¯andå…³ç³»ï¼Œ"$or"çš„æ¡ä»¶æ”¾åˆ°[]å†…,"$not"

#1ã€select * from db1.user where id >= 2 and id < 4;
db.user.find({'_id':{"$gte":2,"$lt":4}})

#2ã€select * from db1.user where id >= 2 and age < 40;
db.user.find({"_id":{"$gte":2},"age":{"$lt":40}})

#3ã€select * from db1.user where id >= 5 or name = "alex";
db.user.find({
    "$or":[
        {'_id':{"$gte":5}},
        {"name":"alex"}
        ]
})

#4ã€select * from db1.user where id % 2=1;
db.user.find({'_id':{"$mod":[2,1]}})

#5ã€ä¸Šé¢˜ï¼Œå–å
db.user.find({'_id':{"$not":{"$mod":[2,1]}}})
```

### æˆå‘˜è¿ç®—

```sql
# SQLï¼šinï¼Œnot in
# MongoDBï¼š"$in","$nin"

#1ã€select * from db1.user where age in (20,30,31);
db.user.find({"age":{"$in":[20,30,31]}})

#2ã€select * from db1.user where name not in ('alex','yuanhao');
db.user.find({"name":{"$nin":['alex','yuanhao']}})
```

### æ­£åˆ™åŒ¹é…

```sql
# SQL: regexp æ­£åˆ™
# MongoDB: /æ­£åˆ™è¡¨è¾¾/i

#1ã€select * from db1.user where name regexp '^j.*?(g|n)$';
db.user.find({'name':/^j.*?(g|n)$/i})
```

### å–æŒ‡å®šçš„å­—æ®µ

1 ä»£è¡¨è¦å–å‡ºæ¥
0 ä»£è¡¨ä¸å–å‡ºæ¥
**é»˜è®¤å…¨æ˜¯1(æ˜¾ç¤º)**

```sql
#1ã€select name,age from db1.user where id=3;
db.user.find({'_id':3},{'_id':0,'name':1,'age':1})
```

### æŸ¥è¯¢æ•°ç»„

```sql
#1ã€æŸ¥çœ‹æœ‰dancingçˆ±å¥½çš„äºº
db.user.find({'hobbies':'dancing'})

#2ã€æŸ¥çœ‹æ—¢æœ‰dancingçˆ±å¥½åˆæœ‰teaçˆ±å¥½çš„äºº
db.user.find({
    'hobbies':{
        "$all":['dancing','tea']
        }
})

#3ã€æŸ¥çœ‹ç¬¬4ä¸ªçˆ±å¥½ä¸ºteaçš„äºº
db.user.find({"hobbies.3":'tea'})

#4ã€æŸ¥çœ‹æ‰€æœ‰äººæœ€åä¸¤ä¸ªçˆ±å¥½
db.user.find({},{'hobbies':{"$slice":-2},"age":0,"_id":0,"name":0,"addr":0})

#5ã€æŸ¥çœ‹æ‰€æœ‰äººçš„ç¬¬2ä¸ªåˆ°ç¬¬3ä¸ªçˆ±å¥½
db.user.find({},{'hobbies':{"$slice":[1,2]},"age":0,"_id":0,"name":0,"addr":0})

> db.blog.find().pretty()
{
        "_id" : 1,
        "name" : "alexæ„å¤–æ­»äº¡çš„çœŸç›¸",
        "comments" : [
                {
                        "name" : "egon",
                        "content" : "alexæ˜¯è°ï¼Ÿï¼Ÿï¼Ÿ",
                        "thumb" : 200
                },
                {
                        "name" : "wxx",
                        "content" : "æˆ‘å»ï¼ŒçœŸçš„å‡çš„",
                        "thumb" : 300
                },
                {
                        "name" : "yxx",
                        "content" : "åƒå–å«–èµŒæŠ½ï¼Œæ¬ ä¸‹ä¸¤ä¸ªäº¿",
                        "thumb" : 40
                },
                {
                        "name" : "egon",
                        "content" : "xxx",
                        "thumb" : 0
                }
        ]
}
db.blog.find({},{'comments':{"$slice":-2}}).pretty() #æŸ¥è¯¢æœ€åä¸¤ä¸ª
db.blog.find({},{'comments':{"$slice":[1,2]}}).pretty() #æŸ¥è¯¢1åˆ°2
```

### æ’åº

```sql
# æ’åº:--1ä»£è¡¨å‡åºï¼Œ-1ä»£è¡¨é™åº
db.user.find().sort({"name":1,})
db.user.find().sort({"age":-1,'_id':1})
```

### åˆ†é¡µ

```sql
# åˆ†é¡µ:--limitä»£è¡¨å–å¤šå°‘ä¸ªdocumentï¼Œskipä»£è¡¨è·³è¿‡å‰å¤šå°‘ä¸ªdocumentã€‚ 
db.user.find().sort({'age':1}).limit(1).skip(2)
```

### è·å–æ•°é‡

```sql
# è·å–æ•°é‡
db.user.count({'age':{"$gt":30}}) 

--æˆ–è€…
db.user.find({'age':{"$gt":30}}).count()
```

### æ‚é¡¹

```sql
#1ã€{'key':null} åŒ¹é…keyçš„å€¼ä¸ºnullæˆ–è€…æ²¡æœ‰è¿™ä¸ªkey
db.t2.insert({'a':10,'b':111})
db.t2.insert({'a':20})
db.t2.insert({'b':null})

> db.t2.find({"b":null})
{ "_id" : ObjectId("5a5cc2a7c1b4645aad959e5a"), "a" : 20 }
{ "_id" : ObjectId("5a5cc2a8c1b4645aad959e5b"), "b" : null }

#2ã€æŸ¥æ‰¾æ‰€æœ‰
db.user.find() #ç­‰åŒäºdb.user.find({})
db.user.find().pretty()

#3ã€æŸ¥æ‰¾ä¸€ä¸ªï¼Œä¸findç”¨æ³•ä¸€è‡´ï¼Œåªæ˜¯åªå–åŒ¹é…æˆåŠŸçš„ç¬¬ä¸€ä¸ª
db.user.findOne({"_id":{"$gt":3}})

```

## æ”¹

### updateè¯­æ³•ä»‹ç»

```sql
update() æ–¹æ³•ç”¨äºæ›´æ–°å·²å­˜åœ¨çš„æ–‡æ¡£ã€‚è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š
db.collection.update(
   <query>,
   <update>,
   {
     upsert: <boolean>,
     multi: <boolean>,
     writeConcern: <document>
   }
)
å‚æ•°è¯´æ˜ï¼šå¯¹æ¯”update db1.t1 set name='EGON',sex='Male' where name='egon' and age=18;

query : ç›¸å½“äºwhereæ¡ä»¶ã€‚
update : updateçš„å¯¹è±¡å’Œä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦ï¼ˆå¦‚$,$inc...ç­‰ï¼Œç›¸å½“äºsetåé¢çš„
upsert : å¯é€‰ï¼Œé»˜è®¤ä¸ºfalseï¼Œä»£è¡¨å¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ä¸æ›´æ–°ä¹Ÿä¸æ’å…¥ï¼Œè®¾ç½®ä¸ºtrueä»£è¡¨æ’å…¥ã€‚
multi : å¯é€‰ï¼Œé»˜è®¤ä¸ºfalseï¼Œä»£è¡¨åªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œè®¾ä¸ºtrue,ä»£è¡¨æ›´æ–°æ‰¾åˆ°çš„å…¨éƒ¨è®°å½•ã€‚
writeConcern :å¯é€‰ï¼ŒæŠ›å‡ºå¼‚å¸¸çš„çº§åˆ«ã€‚

æ›´æ–°æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼šè‹¥ä¸¤ä¸ªæ›´æ–°åŒæ—¶å‘é€ï¼Œå…ˆåˆ°è¾¾æœåŠ¡å™¨çš„å…ˆæ‰§è¡Œï¼Œç„¶åæ‰§è¡Œå¦å¤–ä¸€ä¸ªï¼Œä¸ä¼šç ´åæ–‡æ¡£ã€‚
```

### è¦†ç›–å¼

```sql
#æ³¨æ„ï¼šé™¤éæ˜¯åˆ é™¤ï¼Œå¦åˆ™_idæ˜¯å§‹ç»ˆä¸ä¼šå˜çš„
#1ã€è¦†ç›–å¼:
db.user.update({'age':20},{"name":"Wxx","hobbies_count":3})
æ˜¯ç”¨{"_id":2,"name":"Wxx","hobbies_count":3}è¦†ç›–åŸæ¥çš„è®°å½•

#2ã€ä¸€ç§æœ€ç®€å•çš„æ›´æ–°å°±æ˜¯ç”¨ä¸€ä¸ªæ–°çš„æ–‡æ¡£å®Œå…¨æ›¿æ¢åŒ¹é…çš„æ–‡æ¡£ã€‚è¿™é€‚ç”¨äºå¤§è§„æ¨¡å¼è¿ç§»çš„æƒ…å†µã€‚ä¾‹å¦‚
var obj=db.user.findOne({"_id":2})

obj.username=obj.name+'SB'
obj.hobbies_count++
delete obj.age

db.user.update({"_id":2},obj)
```

### è®¾ç½®set

```sql
#è®¾ç½®ï¼š$set

é€šå¸¸æ–‡æ¡£åªä¼šæœ‰ä¸€éƒ¨åˆ†éœ€è¦æ›´æ–°ã€‚å¯ä»¥ä½¿ç”¨åŸå­æ€§çš„æ›´æ–°ä¿®æ”¹å™¨ï¼ŒæŒ‡å®šå¯¹æ–‡æ¡£ä¸­çš„æŸäº›å­—æ®µè¿›è¡Œæ›´æ–°ã€‚
æ›´æ–°ä¿®æ”¹å™¨æ˜¯ç§ç‰¹æ®Šçš„é”®ï¼Œç”¨æ¥æŒ‡å®šå¤æ‚çš„æ›´æ–°æ“ä½œï¼Œæ¯”å¦‚ä¿®æ”¹ã€å¢åŠ åè€…åˆ é™¤

#1ã€update db1.user set  name="WXX" where id = 2
db.user.update({'_id':2},{"$set":{"name":"WXX",}})

#2ã€æ²¡æœ‰åŒ¹é…æˆåŠŸåˆ™æ–°å¢ä¸€æ¡{"upsert":true}
db.user.update({'_id':6},{"$set":{"name":"egon","age":18}},{"upsert":true})

#3ã€é»˜è®¤åªæ”¹åŒ¹é…æˆåŠŸçš„ç¬¬ä¸€æ¡,{"multi":æ”¹å¤šæ¡}
db.user.update({'_id':{"$gt":4}},{"$set":{"age":28}})
db.user.update({'_id':{"$gt":4}},{"$set":{"age":38}},{"multi":true})

#4ã€ä¿®æ”¹å†…åµŒæ–‡æ¡£ï¼ŒæŠŠåå­—ä¸ºalexçš„äººæ‰€åœ¨çš„åœ°å€å›½å®¶æ”¹æˆJapan
db.user.update({'name':"alex"},{"$set":{"addr.country":"Japan"}})

#5ã€æŠŠåå­—ä¸ºalexçš„äººçš„åœ°2ä¸ªçˆ±å¥½æ”¹æˆpiao
db.user.update({'name':"alex"},{"$set":{"hobbies.1":"piao"}})

#6ã€åˆ é™¤alexçš„çˆ±å¥½,$unset
db.user.update({'name':"alex"},{"$unset":{"hobbies":""}})
```

### å¢åŠ å’Œå‡å°‘ï¼š$inc

**å¦‚æœåŸæœ¬é‡Œé¢æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆå°±ä¼šæ–°é•‡è¿™ä¸ªå€¼å‡ºæ¥**

```sql
#å¢åŠ å’Œå‡å°‘ï¼š$inc

# å¦‚æœåŸæœ¬é‡Œé¢æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆå°±ä¼šæ–°é•‡è¿™ä¸ªå€¼å‡ºæ¥
#1ã€æ‰€æœ‰äººå¹´é¾„å¢åŠ ä¸€å²
db.user.update({},
    {
        "$inc":{"age":1}
    },
    {
        "multi":true
    }
    )
#2ã€æ‰€æœ‰äººå¹´é¾„å‡å°‘5å²
db.user.update({},
    {
        "$inc":{"age":-5}
    },
    {
        "multi":true
    }
    )
    
```

### æ·»åŠ åˆ é™¤æ•°ç»„å†…å…ƒç´ ï¼šğ‘ğ‘¢ğ‘ â„,pop,$pull

```sql
#æ·»åŠ åˆ é™¤æ•°ç»„å†…å…ƒç´ 
    
å¾€æ•°ç»„å†…æ·»åŠ å…ƒç´ :$push
#1ã€ä¸ºåå­—ä¸ºyuanhaoçš„äººæ·»åŠ ä¸€ä¸ªçˆ±å¥½read
db.user.update({"name":"yuanhao"},{"$push":{"hobbies":"read"}})

#2ã€ä¸ºåå­—ä¸ºyuanhaoçš„äººä¸€æ¬¡æ·»åŠ å¤šä¸ªçˆ±å¥½teaï¼Œdancing
db.user.update({"name":"yuanhao"},{"$push":{
    "hobbies":{"$each":["tea","dancing"]}
}})

æŒ‰ç…§ä½ç½®ä¸”åªèƒ½ä»å¼€å¤´æˆ–ç»“å°¾åˆ é™¤å…ƒç´ ï¼š$pop
#3ã€{"$pop":{"key":1}} ä»æ•°ç»„æœ«å°¾åˆ é™¤ä¸€ä¸ªå…ƒç´ 

db.user.update({"name":"yuanhao"},{"$pop":{
    "hobbies":1}
})

#4ã€{"$pop":{"key":-1}} ä»å¤´éƒ¨åˆ é™¤
db.user.update({"name":"yuanhao"},{"$pop":{
    "hobbies":-1}
})

#5ã€æŒ‰ç…§æ¡ä»¶åˆ é™¤å…ƒç´ ,ï¼š"$pull" æŠŠç¬¦åˆæ¡ä»¶çš„ç»Ÿç»Ÿåˆ æ‰ï¼Œè€Œ$popåªèƒ½ä»ä¸¤ç«¯åˆ 
db.user.update({'addr.country':"China"},{"$pull":{
    "hobbies":"read"}
},
{
    "multi":true
}
)
```

### é¿å…æ·»åŠ é‡å¤ï¼š"$addToSet"

```sql
#é¿å…æ·»åŠ é‡å¤ï¼š"$addToSet"

db.urls.insert({"_id":1,"urls":[]})

db.urls.update({"_id":1},{"$addToSet":{"urls":'http://www.baidu.com'}})
db.urls.update({"_id":1},{"$addToSet":{"urls":'http://www.baidu.com'}})
db.urls.update({"_id":1},{"$addToSet":{"urls":'http://www.baidu.com'}})

db.urls.update({"_id":1},{
    "$addToSet":{
        "urls":{
        "$each":[
            'http://www.baidu.com',
            'http://www.baidu.com',
            'http://www.xxxx.com'
            ]
            }
        }
    }
)
```

### å¦‚æœè¦ä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ª(ä¾‹å¦‚åˆ—è¡¨ä¸€ç±»)

```sql
db.urls.update({"_id":1},{
    "$addToSet":{
        "urls":{
        # å¦‚æœæ˜¯åˆ—è¡¨çš„è¯å‰é¢è¦åŠ ä¸ª $ecah
        "$each":[
            'http://www.baidu.com',
            'http://www.baidu.com',
            'http://www.xxxx.com'
            ]
            }
        }
    }
)
```

### å…¶ä»–

```sql
#1ã€äº†è§£ï¼šé™åˆ¶å¤§å°"$slice"ï¼Œåªç•™æœ€ånä¸ª

db.user.update({"_id":5},{
    "$push":{"hobbies":{
        "$each":["read",'music','dancing'],
        "$slice":-2
    }
    }
})

#2ã€äº†è§£ï¼šæ’åºThe $sort element value must be either 1 or -1"
db.user.update({"_id":5},{
    "$push":{"hobbies":{
        "$each":["read",'music','dancing'],
        "$slice":-1,
        "$sort":-1
    }
    }
})

#æ³¨æ„ï¼šä¸èƒ½åªå°†"$slice"æˆ–è€…"$sort"ä¸"$push"é…åˆä½¿ç”¨ï¼Œä¸”å¿…é¡»ä½¿ç”¨"$eah"
```

## åˆ é™¤

```sql
#1ã€åˆ é™¤å¤šä¸ªä¸­çš„ç¬¬ä¸€ä¸ª
db.user.deleteOne({ 'age': 8 })

#2ã€åˆ é™¤å›½å®¶ä¸ºChinaçš„å…¨éƒ¨
db.user.deleteMany( {'addr.country': 'China'} ) 

#3ã€åˆ é™¤å…¨éƒ¨
db.user.deleteMany({}) 
```

## èšåˆ

ç›¸å½“äºç±»ä¼¼äºæ˜¯æ•°æ®åˆ†æ

```sql
å¦‚æœä½ æœ‰æ•°æ®å­˜å‚¨åœ¨MongoDBä¸­ï¼Œä½ æƒ³åšçš„å¯èƒ½å°±ä¸ä»…ä»…æ˜¯å°†æ•°æ®æå–å‡ºæ¥é‚£ä¹ˆç®€å•äº†ï¼›ä½ å¯èƒ½å¸Œæœ›å¯¹æ•°æ®è¿›è¡Œåˆ†æå¹¶åŠ ä»¥åˆ©ç”¨ã€‚MongoDBæä¾›äº†ä»¥ä¸‹èšåˆå·¥å…·ï¼š
#1ã€èšåˆæ¡†æ¶
#2ã€MapReduce(è¯¦è§MongoDBæƒå¨æŒ‡å—)
#3ã€å‡ ä¸ªç®€å•èšåˆå‘½ä»¤ï¼šcountã€distinctå’Œgroupã€‚(è¯¦è§MongoDBæƒå¨æŒ‡å—)

#èšåˆæ¡†æ¶ï¼š
å¯ä»¥ä½¿ç”¨å¤šä¸ªæ„ä»¶åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œä¸Šä¸€ä¸ªæ„ä»¶çš„ç»“æœä¼ ç»™ä¸‹ä¸€ä¸ªæ„ä»¶ã€‚
è¿™äº›æ„ä»¶åŒ…æ‹¬ï¼ˆæ‹¬å·å†…ä¸ºæ„ä»¶å¯¹åº”çš„æ“ä½œç¬¦ï¼‰ï¼šç­›é€‰($match)ã€æŠ•å°„($project)ã€åˆ†ç»„($group)ã€æ’åº($sort)ã€é™åˆ¶($limit)ã€è·³è¿‡($skip)
ä¸åŒçš„ç®¡é“æ“ä½œç¬¦å¯ä»¥ä»»æ„ç»„åˆï¼Œé‡å¤ä½¿ç”¨
```

#### å‡†å¤‡æ•°æ®

```sql
from pymongo import MongoClient
import datetime

client=MongoClient('mongodb://root:123@localhost:27017')
table=client['db1']['emp']
# table.drop()

l=[
('egon','male',18,'20170301','è€ç”·å­©é©»æ²™æ²³åŠäº‹å¤„å¤–äº¤å¤§ä½¿',7300.33,401,1), #ä»¥ä¸‹æ˜¯æ•™å­¦éƒ¨
('alex','male',78,'20150302','teacher',1000000.31,401,1),
('wupeiqi','male',81,'20130305','teacher',8300,401,1),
('yuanhao','male',73,'20140701','teacher',3500,401,1),
('liwenzhou','male',28,'20121101','teacher',2100,401,1),
('jingliyang','female',18,'20110211','teacher',9000,401,1),
('jinxin','male',18,'19000301','teacher',30000,401,1),
('æˆé¾™','male',48,'20101111','teacher',10000,401,1),

('æ­ªæ­ª','female',48,'20150311','sale',3000.13,402,2),#ä»¥ä¸‹æ˜¯é”€å”®éƒ¨é—¨
('ä¸«ä¸«','female',38,'20101101','sale',2000.35,402,2),
('ä¸ä¸','female',18,'20110312','sale',1000.37,402,2),
('æ˜Ÿæ˜Ÿ','female',18,'20160513','sale',3000.29,402,2),
('æ ¼æ ¼','female',28,'20170127','sale',4000.33,402,2),

('å¼ é‡','male',28,'20160311','operation',10000.13,403,3), #ä»¥ä¸‹æ˜¯è¿è¥éƒ¨é—¨
('ç¨‹å’¬é‡‘','male',18,'19970312','operation',20000,403,3),
('ç¨‹å’¬é“¶','female',18,'20130311','operation',19000,403,3),
('ç¨‹å’¬é“œ','male',18,'20150411','operation',18000,403,3),
('ç¨‹å’¬é“','female',18,'20140512','operation',17000,403,3)
]

for n,item in enumerate(l):
    d={
        "_id":n,
        'name':item[0],
        'sex':item[1],
        'age':item[2],
        'hire_date':datetime.datetime.strptime(item[3],'%Y%m%d'),
        'post':item[4],
        'salary':item[5]
    }
    table.save(d)
```

#### ç­›é€‰ï¼š$match

```sql
{"$match":{"å­—æ®µ":"æ¡ä»¶"}},å¯ä»¥ä½¿ç”¨ä»»ä½•å¸¸ç”¨æŸ¥è¯¢æ“ä½œç¬¦$gt,$lt,$inç­‰

#ä¾‹1ã€select * from db1.emp where post='teacher';
db.emp.aggregate({"$match":{"post":"teacher"}})

#ä¾‹2ã€select * from db1.emp where id > 3 group by post;  
db.emp.aggregate(
    {"$match":{"_id":{"$gt":3}}},
    {"$group":{"_id":"$post",'avg_salary':{"$avg":"$salary"}}}
)

#ä¾‹3ã€select * from db1.emp where id > 3 group by post having avg(salary) > 10000;  
db.emp.aggregate(
    {"$match":{"_id":{"$gt":3}}},
    {"$group":{"_id":"$post",'avg_salary':{"$avg":"$salary"}}},
    {"$match":{"avg_salary":{"$gt":10000}}}
)
```

#### æŠ•å°„ï¼š$project

```sql
{"$project":{"è¦ä¿ç•™çš„å­—æ®µå":1,"è¦å»æ‰çš„å­—æ®µå":0,"æ–°å¢çš„å­—æ®µå":"è¡¨è¾¾å¼"}}

#1ã€select name,post,(age+1) as new_age from db1.emp;
db.emp.aggregate(
    {"$project":{
        "name":1,
        "post":1,
        "new_age":{"$add":["$age",1]}
        }
})

#2ã€è¡¨è¾¾å¼ä¹‹æ•°å­¦è¡¨è¾¾å¼
{"$add":[expr1,expr2,...,exprN]} #ç›¸åŠ 
{"$subtract":[expr1,expr2]} #ç¬¬ä¸€ä¸ªå‡ç¬¬äºŒä¸ª
{"$multiply":[expr1,expr2,...,exprN]} #ç›¸ä¹˜
{"$divide":[expr1,expr2]} #ç¬¬ä¸€ä¸ªè¡¨è¾¾å¼é™¤ä»¥ç¬¬äºŒä¸ªè¡¨è¾¾å¼çš„å•†ä½œä¸ºç»“æœ
{"$mod":[expr1,expr2]} #ç¬¬ä¸€ä¸ªè¡¨è¾¾å¼é™¤ä»¥ç¬¬äºŒä¸ªè¡¨è¾¾å¼å¾—åˆ°çš„ä½™æ•°ä½œä¸ºç»“æœ

#3ã€è¡¨è¾¾å¼ä¹‹æ—¥æœŸè¡¨è¾¾å¼:$year,$month,$week,$dayOfMonth,$dayOfWeek,$dayOfYear,$hour,$minute,$second
#ä¾‹å¦‚ï¼šselect name,date_format("%Y") as hire_year from db1.emp
db.emp.aggregate(
    {"$project":{"name":1,"hire_year":{"$year":"$hire_date"}}}
)

#ä¾‹å¦‚æŸ¥çœ‹æ¯ä¸ªå‘˜å·¥çš„å·¥ä½œå¤šé•¿æ—¶é—´
db.emp.aggregate(
    {"$project":{"name":1,"hire_period":{
        "$subtract":[
            {"$year":new Date()},
            {"$year":"$hire_date"}
        ]
    }}}
)

#4ã€å­—ç¬¦ä¸²è¡¨è¾¾å¼
{"$substr":[å­—ç¬¦ä¸²/$å€¼ä¸ºå­—ç¬¦ä¸²çš„å­—æ®µå,èµ·å§‹ä½ç½®,æˆªå–å‡ ä¸ªå­—èŠ‚]}
{"$concat":[expr1,expr2,...,exprN]} #æŒ‡å®šçš„è¡¨è¾¾å¼æˆ–å­—ç¬¦ä¸²è¿æ¥åœ¨ä¸€èµ·è¿”å›,åªæ”¯æŒå­—ç¬¦ä¸²æ‹¼æ¥
{"$toLower":expr}
{"$toUpper":expr}

db.emp.aggregate( {"$project":{"NAME":{"$toUpper":"$name"}}})

#5ã€é€»è¾‘è¡¨è¾¾å¼
$and
$or
$not
å…¶ä»–è§Mongodbæƒå¨æŒ‡å—
```

#### åˆ†ç»„ï¼š$group

```sql
{"$group":{"_id":åˆ†ç»„å­—æ®µ,"æ–°çš„å­—æ®µå":èšåˆæ“ä½œç¬¦}}

#1ã€å°†åˆ†ç»„å­—æ®µä¼ ç»™$groupå‡½æ•°çš„_idå­—æ®µå³å¯
{"$group":{"_id":"$sex"}} #æŒ‰ç…§æ€§åˆ«åˆ†ç»„
{"$group":{"_id":"$post"}} #æŒ‰ç…§èŒä½åˆ†ç»„
{"$group":{"_id":{"state":"$state","city":"$city"}}} #æŒ‰ç…§å¤šä¸ªå­—æ®µåˆ†ç»„ï¼Œæ¯”å¦‚æŒ‰ç…§å·å¸‚åˆ†ç»„

#2ã€åˆ†ç»„åèšåˆå¾—ç»“æœ,ç±»ä¼¼äºsqlä¸­èšåˆå‡½æ•°çš„èšåˆæ“ä½œç¬¦ï¼š$sumã€$avgã€$maxã€$minã€$firstã€$last
#ä¾‹1ï¼šselect post,max(salary) from db1.emp group by post; 
db.emp.aggregate({"$group":{"_id":"$post","max_salary":{"$max":"$salary"}}})

#ä¾‹2ï¼šå»æ¯ä¸ªéƒ¨é—¨æœ€å¤§è–ªèµ„ä¸æœ€ä½è–ªèµ„
db.emp.aggregate({"$group":{"_id":"$post","max_salary":{"$max":"$salary"},"min_salary":{"$min":"$salary"}}})

#ä¾‹3ï¼šå¦‚æœå­—æ®µæ˜¯æ’åºåçš„ï¼Œé‚£ä¹ˆ$first,$lastä¼šå¾ˆæœ‰ç”¨,æ¯”ç”¨$maxå’Œ$minæ•ˆç‡é«˜
db.emp.aggregate({"$group":{"_id":"$post","first_id":{"$first":"$_id"}}})

#ä¾‹4ï¼šæ±‚æ¯ä¸ªéƒ¨é—¨çš„æ€»å·¥èµ„
db.emp.aggregate({"$group":{"_id":"$post","count":{"$sum":"$salary"}}})

#ä¾‹5ï¼šæ±‚æ¯ä¸ªéƒ¨é—¨çš„äººæ•°
db.emp.aggregate({"$group":{"_id":"$post","count":{"$sum":1}}})

#3ã€æ•°ç»„æ“ä½œç¬¦
{"$addToSet":expr}ï¼šä¸é‡å¤
{"$push":expr}ï¼šé‡å¤

#ä¾‹ï¼šæŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½å†…çš„å‘˜å·¥å§“å:select post,group_concat(name) from db1.emp group by post;
db.emp.aggregate({"$group":{"_id":"$post","names":{"$push":"$name"}}})
db.emp.aggregate({"$group":{"_id":"$post","names":{"$addToSet":"$name"}}})
```

#### æ’åºï¼šğ‘ ğ‘œğ‘Ÿğ‘¡ã€é™åˆ¶ï¼šlimitã€è·³è¿‡ï¼š$skip

```sql
{"$sort":{"å­—æ®µå":1,"å­—æ®µå":-1}} #1å‡åºï¼Œ-1é™åº
{"$limit":n} 
{"$skip":n} #è·³è¿‡å¤šå°‘ä¸ªæ–‡æ¡£

#ä¾‹1ã€å–å¹³å‡å·¥èµ„æœ€é«˜çš„å‰ä¸¤ä¸ªéƒ¨é—¨
db.emp.aggregate(
{
    "$group":{"_id":"$post","å¹³å‡å·¥èµ„":{"$avg":"$salary"}}
},
{
    "$sort":{"å¹³å‡å·¥èµ„":-1}
},
{
    "$limit":2
}
)
#ä¾‹2ã€
db.emp.aggregate(
{
    "$group":{"_id":"$post","å¹³å‡å·¥èµ„":{"$avg":"$salary"}}
},
{
    "$sort":{"å¹³å‡å·¥èµ„":-1}
},
{
    "$limit":2
},
{
    "$skip":1
}
)
```

#### éšæœºé€‰å–nä¸ªï¼š$sample

```sql
#é›†åˆusersåŒ…å«çš„æ–‡æ¡£å¦‚ä¸‹
{ "_id" : 1, "name" : "dave123", "q1" : true, "q2" : true }
{ "_id" : 2, "name" : "dave2", "q1" : false, "q2" : false  }
{ "_id" : 3, "name" : "ahn", "q1" : true, "q2" : true  }
{ "_id" : 4, "name" : "li", "q1" : true, "q2" : false  }
{ "_id" : 5, "name" : "annT", "q1" : false, "q2" : true  }
{ "_id" : 6, "name" : "li", "q1" : true, "q2" : true  }
{ "_id" : 7, "name" : "ty", "q1" : false, "q2" : true  }

#ä¸‹è¿°æ“ä½œæ—¶ä»usersé›†åˆä¸­éšæœºé€‰å–3ä¸ªæ–‡æ¡£
db.users.aggregate(
   [ { $sample: { size: 3 } } ]
)
```

## ç»ƒä¹ é¢˜

1. æŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½å†…çš„å‘˜å·¥å§“å
2. æŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½å†…åŒ…å«çš„å‘˜å·¥ä¸ªæ•°
3. æŸ¥è¯¢å…¬å¸å†…ç”·å‘˜å·¥å’Œå¥³å‘˜å·¥çš„ä¸ªæ•°
4. æŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½çš„å¹³å‡è–ªèµ„ã€æœ€é«˜è–ªèµ„ã€æœ€ä½è–ªèµ„
5. æŸ¥è¯¢ç”·å‘˜å·¥ä¸ç”·å‘˜å·¥çš„å¹³å‡è–ªèµ„ï¼Œå¥³å‘˜å·¥ä¸å¥³å‘˜å·¥çš„å¹³å‡è–ªèµ„
6. æŸ¥è¯¢å„å²—ä½å†…åŒ…å«çš„å‘˜å·¥ä¸ªæ•°å°äº2çš„å²—ä½åã€å²—ä½å†…åŒ…å«å‘˜å·¥åå­—ã€ä¸ªæ•°
7. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000çš„å²—ä½åã€å¹³å‡å·¥èµ„
8. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000ä¸”å°äº20000çš„å²—ä½åã€å¹³å‡å·¥èµ„
9. æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥ä¿¡æ¯ï¼Œå…ˆæŒ‰ç…§ageå‡åºæ’åºï¼Œå¦‚æœageç›¸åŒåˆ™æŒ‰ç…§hire_dateé™åºæ’åº
10. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000çš„å²—ä½åã€å¹³å‡å·¥èµ„,ç»“æœæŒ‰å¹³å‡è–ªèµ„å‡åºæ’åˆ—
11. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000çš„å²—ä½åã€å¹³å‡å·¥èµ„,ç»“æœæŒ‰å¹³å‡è–ªèµ„é™åºæ’åˆ—,å–å‰1ä¸ª

### ç»ƒä¹ ç­”æ¡ˆ

1. æŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½å†…çš„å‘˜å·¥å§“å
db.emp.aggregate({"$group":{"_id":"$post","names":{"$push":"$name"}}})

2. æŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½å†…åŒ…å«çš„å‘˜å·¥ä¸ªæ•°
db.emp.aggregate({"$group":{"_id":"$post","count":{"$sum":1}}})

3. æŸ¥è¯¢å…¬å¸å†…ç”·å‘˜å·¥å’Œå¥³å‘˜å·¥çš„ä¸ªæ•°
db.emp.aggregate({"$group":{"_id":"$sex","count":{"$sum":1}}})

4. æŸ¥è¯¢å²—ä½åä»¥åŠå„å²—ä½çš„å¹³å‡è–ªèµ„ã€æœ€é«˜è–ªèµ„ã€æœ€ä½è–ªèµ„
db.emp.aggregate({"$group":{"_id":"$post","avg_salary":{"$avg":"$salary"},"max_salary":{"$max":"$salary"},"min_salary":{"$min":"$salary"}}})

5. æŸ¥è¯¢ç”·å‘˜å·¥ä¸ç”·å‘˜å·¥çš„å¹³å‡è–ªèµ„ï¼Œå¥³å‘˜å·¥ä¸å¥³å‘˜å·¥çš„å¹³å‡è–ªèµ„
db.emp.aggregate({"$group":{"_id":"$sex","avg_salary":{"$avg":"$salary"}}})

6. æŸ¥è¯¢å„å²—ä½å†…åŒ…å«çš„å‘˜å·¥ä¸ªæ•°å°äº2çš„å²—ä½åã€å²—ä½å†…åŒ…å«å‘˜å·¥åå­—ã€ä¸ªæ•°
db.emp.aggregate(
{
    "$group":{"_id":"$post","count":{"$sum":1},"names":{"$push":"$name"}}
},
{"$match":{"count":{"$lt":2}}},
{"$project":{"_id":0,"names":1,"count":1}}
)

7. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000çš„å²—ä½åã€å¹³å‡å·¥èµ„
db.emp.aggregate(
{
    "$group":{"_id":"$post","avg_salary":{"$avg":"$salary"}}
},
{"$match":{"avg_salary":{"$gt":10000}}},
{"$project":{"_id":1,"avg_salary":1}}
)

8. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000ä¸”å°äº20000çš„å²—ä½åã€å¹³å‡å·¥èµ„
db.emp.aggregate(
{
    "$group":{"_id":"$post","avg_salary":{"$avg":"$salary"}}
},
{"$match":{"avg_salary":{"$gt":10000,"$lt":20000}}},
{"$project":{"_id":1,"avg_salary":1}}
)

9. æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥ä¿¡æ¯ï¼Œå…ˆæŒ‰ç…§ageå‡åºæ’åºï¼Œå¦‚æœageç›¸åŒåˆ™æŒ‰ç…§hire_dateé™åºæ’åº
db.emp.aggregate(
{"$sort":{"age":1,"hire_date":-1}}
)

10. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000çš„å²—ä½åã€å¹³å‡å·¥èµ„,ç»“æœæŒ‰å¹³å‡è–ªèµ„å‡åºæ’åˆ—
db.emp.aggregate(
{
    "$group":{"_id":"$post","avg_salary":{"$avg":"$salary"}}
},
{"$match":{"avg_salary":{"$gt":10000}}},
{"$sort":{"avg_salary":1}}
)

11. æŸ¥è¯¢å„å²—ä½å¹³å‡è–ªèµ„å¤§äº10000çš„å²—ä½åã€å¹³å‡å·¥èµ„,ç»“æœæŒ‰å¹³å‡è–ªèµ„é™åºæ’åˆ—,å–å‰1ä¸ª
db.emp.aggregate(
{
    "$group":{"_id":"$post","avg_salary":{"$avg":"$salary"}}
},
{"$match":{"avg_salary":{"$gt":10000}}},
{"$sort":{"avg_salary":-1}},
{"$limit":1},
{"$project":{"date":new Date,"å¹³å‡å·¥èµ„":"$avg_salary","_id":0}}
)

## å¯è§†åŒ–å·¥å…·

> [å¯è§†åŒ–å·¥å…·](https://robomongo.org/)

## pymongo

> [pymongo](http://api.mongodb.com/python/current/tutorial.html)

<CommentService/>
